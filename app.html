<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Molecule Mutation Tool â€“ Analyze Your Change</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- this is app.html -->
  <meta
    name="description"
    content="Describe a base molecule and a mutation. The AI explains how the change affects reactivity, mechanisms, IUPAC names, and predicts the mutated structure."
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="logo">
        <span class="logo-icon">ðŸ§ª</span>
        <span class="logo-text">Molecule Mutation Generator</span>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="index.html#how-it-works">How it works</a>
        <a href="index.html#features">Features</a>
        <a href="app.html" class="nav-cta">Try the tool</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="section-inner">
        <h1>Molecule Mutation Tool</h1>
        <p class="section-subtitle">
          Describe a molecule and the change you want to make. The AI will show how that mutation affects
          reactivity, acidity/basicity, sterics, electronics, stability, IUPAC names,
          and will attempt to predict the structure after the mutation.
        </p>

        <form
          id="mutation-form"
          class="example-block"
          style="margin-top: 1.5rem;"
          method="POST"
          action="javascript:void(0);"
        >
          <label class="example-label">
            Base molecule
          </label>
          <textarea
            name="base_molecule"
            rows="3"
            class="inline-mono"
            placeholder="e.g., secondary alkyl bromide: CH3â€“CHBrâ€“CH2â€“CH3"
            required
          ></textarea>

          <label class="example-label" style="margin-top: 0.8rem;">
            Mutation
          </label>
          <textarea
            name="mutation"
            rows="3"
            class="inline-mono"
            placeholder="e.g., replace Br with OTs; add a nitro group para to the methyl."
            required
          ></textarea>

          <!-- ðŸ§ª Optional SMILES input for base structure rendering -->
          <label class="example-label" style="margin-top: 0.8rem;">
            Optional SMILES for base molecule (for drawing)
          </label>
          <input
            type="text"
            name="smiles"
            id="smiles-input"
            class="inline-mono"
            placeholder="e.g., CC(=O)Oc1ccccc1C(=O)O"
          />

          <label class="example-label" style="margin-top: 0.8rem;">
            Optional question / context
          </label>
          <textarea
            name="question"
            rows="2"
            class="inline-mono"
            placeholder="e.g., How does this affect SN1 vs SN2?"
          ></textarea>

          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">Analyze mutation</button>
            <span id="loading-indicator" class="inline-mono" style="font-size: 0.8rem; display: none;">
              Analyzingâ€¦
            </span>
          </div>

          <div id="error" class="error" style="display: none; margin-top: 0.75rem;"></div>
        </form>

        <!-- Results section -->
        <section id="results" class="section" style="margin-top: 2rem;">
          <div class="section-inner">
            <h2>Analysis Result</h2>
            <p id="summary"></p>

            <!-- ðŸ§ª Structures -->
            <h3 style="margin-top: 1.3rem;">Structures</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
              <!-- Before -->
              <div class="example-block" style="display: inline-block;">
                <p class="example-label">Before mutation</p>
                <canvas
                  id="smiles-canvas-before"
                  width="320"
                  height="320"
                  style="
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #ffffff;
                  "
                ></canvas>
                <p
                  id="smiles-error-before"
                  class="error"
                  style="display: none; margin-top: 0.5rem; font-size: 0.85rem;"
                ></p>
              </div>

              <!-- After -->
              <div class="example-block" style="display: inline-block;">
                <p class="example-label">After mutation (AI-predicted)</p>
                <canvas
                  id="smiles-canvas-after"
                  width="320"
                  height="320"
                  style="
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #ffffff;
                  "
                ></canvas>
                <p
                  id="smiles-error-after"
                  class="error"
                  style="display: none; margin-top: 0.5rem; font-size: 0.85rem;"
                ></p>
              </div>
            </div>

            <!-- IUPAC names -->
            <h3 style="margin-top: 1.3rem;">IUPAC names</h3>
            <div class="example-block">
              <p class="example-label">Before mutation</p>
              <p id="iupac-before"></p>

              <p class="example-label" style="margin-top: 0.75rem;">After mutation</p>
              <p id="iupac-after"></p>

              <p class="example-label" style="margin-top: 0.75rem;">Notes</p>
              <p id="iupac-notes"></p>
            </div>

            <h3 style="margin-top: 1.3rem;">Key changes</h3>
            <ul id="key-changes" class="example-block"></ul>

            <h3 style="margin-top: 1.3rem;">Mechanisms</h3>
            <div class="example-block">
              <p class="example-label">Before mutation</p>
              <p id="mech-before"></p>

              <p class="example-label">After mutation</p>
              <p id="mech-after"></p>

              <p class="example-label">Comparison</p>
              <p id="mech-comparison"></p>
            </div>

            <h3 style="margin-top: 1.3rem;">Example reactions</h3>
            <ul id="example-reactions" class="example-block"></ul>

            <h3 style="margin-top: 1.3rem;">Explanations</h3>
            <div class="example-block">
              <details open>
                <summary>Simple explanation</summary>
                <p id="explain-simple" style="margin-top: 0.5rem;"></p>
              </details>
              <details style="margin-top: 0.75rem;">
                <summary>Detailed explanation</summary>
                <p id="explain-detailed" style="margin-top: 0.5rem;"></p>
              </details>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <p>ðŸ§ª Molecule Mutation Generator</p>
      <p class="footer-small">
        Educational tool. Do not use as a substitute for real lab safety or professional chemical advice.
      </p>
    </div>
  </footer>

  <!-- SmilesDrawer library -->
  <script src="https://unpkg.com/smiles-drawer@1.0.10/dist/smiles-drawer.min.js"></script>

  <!-- Initialize SmilesDrawer and expose a helper for app.js -->
  <script>
    let smilesDrawer = null;

    document.addEventListener("DOMContentLoaded", function () {
      if (window.SmilesDrawer) {
        // High-contrast custom theme on a white background
        smilesDrawer = new SmilesDrawer.Drawer({
          width: 320,
          height: 320,
          themes: {
            darkcanvas: {
              background: '#FFFFFF',
              bond: '#000000',
              carbon: '#000000',
              atomColors: {
                O: '#FF0000',
                N: '#0000FF',
                S: '#FFC800',
                F: '#00AA00',
                Cl: '#00AA00',
                Br: '#A52A2A'
              }
            }
          },
          drawBackground: true
        });
        console.log("SmilesDrawer Drawer initialized:", smilesDrawer);
      } else {
        console.error("SmilesDrawer failed to load.");
      }
    });

    // Global helper function that app.js can call
    window.renderSmilesToCanvas = function (smiles, canvasId, errorId) {
      if (!smilesDrawer || !window.SmilesDrawer) return;

      const canvas = document.getElementById(canvasId);
      const errEl = errorId ? document.getElementById(errorId) : null;

      if (!canvas) return;

      // Clear any previous error
      if (errEl) {
        errEl.style.display = "none";
        errEl.textContent = "";
      }

      const ctx = canvas.getContext("2d");
      // Clear previous drawing
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const clean = (smiles || "").trim();
      if (!clean) {
        return;
      }

      console.log("Trying to draw SMILES on", canvasId, ":", clean);

      SmilesDrawer.parse(
        clean,
        function (tree) {
          try {
            smilesDrawer.draw(tree, canvasId, "darkcanvas", false);
          } catch (drawErr) {
            console.error("SmilesDrawer draw error:", drawErr);
            if (errEl) {
              errEl.textContent = "Could not render structure.";
              errEl.style.display = "block";
            }
          }
        },
        function (err) {
          console.error("SmilesDrawer parse error:", err);
          if (errEl) {
            errEl.textContent =
              "Could not parse SMILES. Please check the string.";
            errEl.style.display = "block";
          }
        }
      );
    };
  </script>

  <script src="app.js"></script>
</body>
</html>
